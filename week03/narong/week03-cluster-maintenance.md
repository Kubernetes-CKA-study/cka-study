# 1. Drain, Cordon

쿠버네티스 클러스터를 운영하다 보면 소프트웨어 업그레이드나 보안 패치 적용을 위해 특정 노드를 잠시 내려야 할(Down) 때가 있습니다. 이때 아무런 조치 없이 노드를 꺼버리면 어떻게 될까요? 해당 노드에 있던 파드들은 강제로 종료되고 서비스에 장애가 발생할 수 있습니다.

## 1.1. 노드가 갑자기 죽으면 생기는 일 (Node Failure)

장애로 인해 노드가 갑자기 응답하지 않게 되었다고 가정해 봅시다.

1. **Pod Eviction Timeout (기본 5분):** 쿠버네티스 마스터는 노드 상태가 `NotReady`로 변해도 바로 파드를 다른 곳으로 옮기지 않습니다. "잠깐 네트워크가 끊긴 걸 수도 있잖아?"라며 **5분**(`pod-eviction-timeout`)을 기다립니다.
2. **5분 후:** 여전히 응답이 없으면 해당 노드의 파드들을 **Dead**로 간주하고 종료 처리합니다.
3. **재생성:**
    - **ReplicaSet**의 관리 하에 있는 파드들은 다른 건강한 노드에서 재생성됩니다.
    - **단독(Standalone) 파드**들은 영원히 사라집니다. (이것이 우리가 항상 ReplicaSet이나 Deployment를 써야 하는 이유입니다!)

하지만 계획된 유지보수라면 5분이나 기다릴 필요도 위험을 감수할 필요도 없습니다. 우리는 "나 이제 이 노드 점검할 거야, 파드들 미리 비워줘"라고 말할 수 있습니다.

## 1.2. `kubectl drain`

특정 노드에서 실행 중인 모든 파드를 안전하게 쫓아내고(Evict), 다른 노드로 이사시키는 명령어입니다.

```
kubectl drain <노드이름> --ignore-daemonsets
```

### 동작 과정

1. **Unschedulable 설정:** 먼저 해당 노드에 **"출입 금지"** 표지판을 겁니다. (더 이상 새로운 파드가 이 노드에 스케줄링되지 않습니다.)
2. **파드 퇴거(Eviction):** 실행 중이던 파드들을 하나씩 종료시킵니다(Graceful Termination).
3. **재배치:** ReplicaSet에 의해 파드들은 다른 노드(Node 2, Node 3 등)에 새로 생성됩니다.

> Tip!! --ignore-daemonsets 옵션은 필수적으로 자주 쓰입니다. DaemonSet으로 생성된 파드(로그 수집기 등)는 노드 귀속적이라 다른 곳으로 옮길 수 없기 때문에 이를 무시하고 진행하기 위함입니다.
> 

## 1.3. `kubectl cordon`

`drain`은 파드를 쫓아내기까지 하지만 `cordon`은 단순히 "새로운 파드만 안 받겠다"는 설정입니다.

```
kubectl cordon <노드이름>
```

- **동작:** 해당 노드를 `SchedulingDisabled` 상태로 마킹합니다.
- **기존 파드:** 이미 실행 중인 파드들은 건드리지 않고 계속 실행됩니다.
- **새로운 파드:** 이 노드에는 배치되지 않습니다.

**언제 쓸까요?**

- 노드에 문제가 있어 보이는데 당장 파드를 죽이기는 부담스럽고 더 이상 부하를 주고 싶지 않을 때 사용합니다.
- 사실 `drain` 명령어를 치면 내부적으로 먼저 `cordon`이 수행된 후 파드 퇴거가 진행됩니다.

## 1.4.`kubectl uncordon`

유지보수가 끝났고 노드가 다시 건강해졌습니다. 이제 다시 파드를 받아야겠죠?

```
kubectl uncordon <노드이름>
```

이 명령어를 입력하면 노드의 `SchedulingDisabled` 상태가 풀리고 다시 정상적으로 파드가 스케줄링될 수 있게 됩니다.

# 2, 무중단 업그레이드

## 2.1. 버전 차이 정책 (Version Skew Policy)

쿠버네티스 업그레이드의 핵심은 **모든 컴포넌트의 버전이 똑같을 필요는 없다**는 점입니다. 이를 통해 서비스 중단 없는 라이브 업그레이드가 가능합니다.

중심은 항상 **kube-apiserve**r입니다. 다른 컴포넌트들은 이 API 서버와 통신해야 하므로 API 서버보다 버전이 높아서는 안 됩니다.

### 버전 호환성 규칙 (API 서버가 버전 X일 때)

1. **Controller Manager & Scheduler:** X (동일) 또는 X-1 (한 단계 하위)까지 가능.
2. **Kubelet & Kube-Proxy:** X (동일) 또는 X-2 (두 단계 하위)까지 가능.
3. **kubectl (CLI 도구):** X+1, X, X-1 (위아래로 한 단계)까지 가능.

> 결론: 업그레이드는 항상 마스터 노드(Control Plane)부터 진행하고, 그 후에 워커 노드를 진행해야 합니다.
> 

## 2.2. 업그레이드 전략 (Strategy)

### 1) 한 단계씩 올라가라 (One Minor Version at a Time)

쿠버네티스는 최근 **3개의 마이너 버전**만 지원합니다. 지원 기간이 지나면 보안 패치를 받을 수 없으므로 시기적절한 업그레이드가 중요합니다.

- **가능:** v1.10 -> v1.11 -> v1.12
- **불가능:** v1.10 -> v1.12 (점프 업그레이드 불가)

반드시 한 단계씩 순차적으로 업그레이드해야 합니다.

### 2) 업그레이드 방법 선택 (Upgrade Methods)

환경에 따라 적절한 업그레이드 방식을 선택해야 합니다.

- **Managed Service (GKE, EKS, AKS):** 클라우드 제공자가 제어 영역(Control Plane) 업그레이드를 대신 수행해 줍니다. 버튼 클릭이나 간단한 명령어로 가능합니다.
- **Kubeadm:** 클러스터 구축 도구인 Kubeadm을 사용하여 업그레이드를 진행합니다. (본 가이드의 중점 내용)
- **Manual (Hard way):** 모든 바이너리를 직접 다운로드하고 설정 파일을 수정하는 방식으로, 고난이도 작업입니다.

### 3) 마스터 노드 먼저, 그 다음 워커 노드

1. **마스터 노드 업그레이드:**
    - 업그레이드 중에는 API 서버가 잠시 다운됩니다.
    - `kubectl` 명령어가 안 먹히고, 새로운 파드 생성이 불가능합니다.
    - 하지만 **기존 워커 노드에서 돌고 있는 파드들은 정상적으로 계속 실행**됩니다. (서비스 중단 없음)
2. **워커 노드 업그레이드:**
    - **전체 동시 업그레이드:** 서비스 다운타임 발생 (비추천)
    - **롤링 업그레이드 (하나씩):** 하나씩 노드를 비우고(Drain) 업그레이드. (무중단, 추천)
    - **새 노드 추가:** 새 버전의 노드를 추가하고 기존 노드를 제거. (클라우드 환경에서 추천)

## 2.3. kubeadm을 이용한 업그레이드 절차

가장 일반적인 `kubeadm` 기반의 업그레이드 순서입니다.

### Step 1: 마스터 노드 (Control Plane) 업그레이드

먼저 마스터 노드에 접속하여 진행합니다.

1. **kubeadm 업그레이드:** 도구부터 최신화합니다.
    
    ```
    apt-get upgrade -y kubeadm=1.11.0-00
    ```
    
2. **업그레이드 계획 확인:** 현재 버전과 업그레이드 가능 버전을 확인합니다.
    
    ```
    kubeadm upgrade plan
    ```
    
3. **적용 (Apply):** 실제 클러스터 컴포넌트(파드들)를 업그레이드합니다.
    
    ```
    kubeadm upgrade apply v1.11.0
    ```
    
4. **Kubelet 업그레이드:** 마지막으로 노드 에이전트인 kubelet을 업그레이드하고 재시작합니다.
    
    ```
    apt-get upgrade -y kubelet=1.11.0-00
    systemctl restart kubelet
    ```
    

### Step 2: 워커 노드 (Worker Nodes) 업그레이드

마스터 노드가 완료되면, 워커 노드를 하나씩 순차적으로 작업합니다.

1. **Drain (마스터 노드에서 수행):** 워커 노드를 비워서 파드를 다른 곳으로 옮깁니다.
    
    ```
    kubectl drain node-1 --ignore-daemonsets
    ```
    
2. **kubeadm & kubelet 업그레이드 (워커 노드에서 수행):**
    
    ```
    apt-get upgrade -y kubeadm=1.11.0-00
    apt-get upgrade -y kubelet=1.11.0-00
    ```
    
3. **노드 설정 업데이트 (워커 노드에서 수행):**
    
    ```
    kubeadm upgrade node
    systemctl restart kubelet
    ```
    
4. **Uncordon (마스터 노드에서 수행):** 노드를 다시 스케줄링 가능 상태로 풉니다.

    ```
    kubectl uncordon node-1
    ```
